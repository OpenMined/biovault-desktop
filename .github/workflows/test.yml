name: Test

on:
  workflow_dispatch:
  push:
    branches:
      - "main"
      - "dev"
  pull_request:
    branches:
      - "**"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Run lint checks
        run: ./lint.sh

  test-ui:
    name: UI tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: '1.1.38'

      - name: Install npm dependencies
        run: npm ci

      - name: Install bun dependencies
        run: bun install --frozen-lockfile

      - name: Install Playwright browsers
        run: bunx --bun playwright install --with-deps chromium

      - name: Run UI tests (headless)
        env:
          SKIP_PLAYWRIGHT_INSTALL: "1"
        run: ./test-ui.sh

  windows-x64-build:
    name: Windows x64 build
    runs-on: windows-latest
    if: github.event_name == 'pull_request' && github.event.pull_request.base.ref == 'main'
    env:
      TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
      TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
    steps:
      - name: Enable Windows long paths
        run: git config --system core.longpaths true

      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install protoc
        uses: arduino/setup-protoc@v2
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Tauri CLI
        run: npm install -g @tauri-apps/cli@latest

      - name: Install npm dependencies
        run: npm ci

      - name: Create placeholder resources (Windows - no bundled deps)
        shell: pwsh
        run: |
          # Create placeholder directories and files for resources that tauri.conf.json expects
          New-Item -Path "src-tauri/resources/syftbox" -ItemType Directory -Force
          New-Item -Path "src-tauri/resources/bundled/java" -ItemType Directory -Force
          New-Item -Path "src-tauri/resources/bundled/nextflow" -ItemType Directory -Force
          New-Item -Path "src-tauri/resources/bundled/uv" -ItemType Directory -Force

          # Create placeholder files (syftbox without extension - matches tauri.conf.json)
          New-Item -Path "src-tauri/resources/syftbox/syftbox" -ItemType File -Force
          "Placeholder - bundled deps not included in Windows PR build" | Out-File -FilePath "src-tauri/resources/bundled/README.txt"
          New-Item -Path "src-tauri/resources/bundled/java/.placeholder" -ItemType File -Force
          New-Item -Path "src-tauri/resources/bundled/nextflow/.placeholder" -ItemType File -Force
          New-Item -Path "src-tauri/resources/bundled/uv/.placeholder" -ItemType File -Force

      - name: Build app
        shell: pwsh
        run: |
          tauri build --target x86_64-pc-windows-msvc

      - name: Verify artifacts
        shell: pwsh
        run: |
          Write-Host "Checking for built artifacts..."
          Get-ChildItem -Path "src-tauri/target/x86_64-pc-windows-msvc/release/bundle/nsis" -ErrorAction SilentlyContinue | Format-Table

  macos-arm64-build:
    name: macOS arm64 build
    runs-on: macos-latest
    if: github.event_name == 'pull_request' && github.event.pull_request.base.ref == 'main'
    env:
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
      TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
      TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Import signing certificate into keychain
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.SIGNING_CERTIFICATE_P12_DATA }}
          p12-password: ${{ secrets.SIGNING_CERTIFICATE_PASSWORD }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install protoc
        uses: arduino/setup-protoc@v2
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Tauri CLI
        run: npm install -g @tauri-apps/cli@latest

      - name: Setup Go (syftbox)
        uses: actions/setup-go@v5
        with:
          go-version-file: biovault/syftbox/go.mod
          cache: true
          cache-dependency-path: biovault/syftbox/go.sum

      - name: Install npm dependencies
        run: npm ci

      - name: Fetch bundled dependencies
        run: |
          chmod +x scripts/fetch-bundled-deps.sh
          ./scripts/fetch-bundled-deps.sh
          chmod -R u+rw src-tauri/resources/bundled/ || true
          xattr -r -d com.apple.quarantine src-tauri/resources/bundled/ 2>/dev/null || true

      - name: Build syftbox client
        run: |
          chmod +x scripts/build-syftbox-prod.sh
          ./scripts/build-syftbox-prod.sh

      - name: Sign bundled binaries
        run: |
          echo "Signing all bundled binaries for notarization..."

          # Sign syftbox
          SYFTBOX_BIN="src-tauri/resources/syftbox/syftbox"
          if [[ -f "$SYFTBOX_BIN" ]]; then
            echo "Signing syftbox client..."
            codesign --force --options runtime --timestamp --sign "$APPLE_SIGNING_IDENTITY" "$SYFTBOX_BIN"
          fi

          # Sign all uv binaries
          if [[ -d "src-tauri/resources/bundled/uv" ]]; then
            find src-tauri/resources/bundled/uv -type f -perm +111 | while read -r bin; do
              echo "Signing uv binary: $bin"
              codesign --force --options runtime --timestamp --sign "$APPLE_SIGNING_IDENTITY" "$bin"
            done
          fi

          # Sign all java binaries
          if [[ -d "src-tauri/resources/bundled/java" ]]; then
            find src-tauri/resources/bundled/java -type f -perm +111 | while read -r bin; do
              echo "Signing java binary: $bin"
              codesign --force --options runtime --timestamp --sign "$APPLE_SIGNING_IDENTITY" "$bin" || true
            done
            find src-tauri/resources/bundled/java -name "*.dylib" -type f | while read -r lib; do
              echo "Signing java dylib: $lib"
              codesign --force --options runtime --timestamp --sign "$APPLE_SIGNING_IDENTITY" "$lib" || true
            done
          fi

          # Sign all nextflow binaries
          if [[ -d "src-tauri/resources/bundled/nextflow" ]]; then
            find src-tauri/resources/bundled/nextflow -type f -perm +111 | while read -r bin; do
              echo "Signing nextflow binary: $bin"
              codesign --force --options runtime --timestamp --sign "$APPLE_SIGNING_IDENTITY" "$bin" || true
            done
          fi

          echo "Finished signing bundled binaries"

      - name: Build app
        run: |
          tauri build --target aarch64-apple-darwin

      - name: Verify artifacts
        run: |
          echo "Checking for built artifacts..."
          ls -lh src-tauri/target/aarch64-apple-darwin/release/bundle/dmg/ || echo "No dmg directory"
          ls -lh src-tauri/target/aarch64-apple-darwin/release/bundle/macos/ || echo "No macos directory"

      - name: Clean up keychains
        if: always()
        run: |
          keychains=$(security list-keychains | tr -d '" "')
          echo "$keychains" | while IFS= read -r keychain; do
            if [[ "$keychain" != "/Library/Keychains/System.keychain" && "$keychain" != "/Library/Keychains/SystemRootCertificates.keychain" ]]; then
              echo "Deleting keychain: $keychain"
              security delete-keychain "$keychain"
            fi
          done

  macos-x64-build:
    name: macOS x64 build
    runs-on: macos-latest
    if: github.event_name == 'pull_request' && github.event.pull_request.base.ref == 'main'
    env:
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
      TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
      TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Import signing certificate into keychain
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.SIGNING_CERTIFICATE_P12_DATA }}
          p12-password: ${{ secrets.SIGNING_CERTIFICATE_PASSWORD }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install protoc
        uses: arduino/setup-protoc@v2
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Tauri CLI
        run: npm install -g @tauri-apps/cli@latest

      - name: Setup Go (syftbox)
        uses: actions/setup-go@v5
        with:
          go-version-file: biovault/syftbox/go.mod
          cache: true
          cache-dependency-path: biovault/syftbox/go.sum

      - name: Install npm dependencies
        run: npm ci

      - name: Fetch bundled dependencies
        run: |
          chmod +x scripts/fetch-bundled-deps.sh
          ./scripts/fetch-bundled-deps.sh
          chmod -R u+rw src-tauri/resources/bundled/ || true
          xattr -r -d com.apple.quarantine src-tauri/resources/bundled/ 2>/dev/null || true

      - name: Build syftbox client
        run: |
          chmod +x scripts/build-syftbox-prod.sh
          ./scripts/build-syftbox-prod.sh

      - name: Sign bundled binaries
        run: |
          echo "Signing all bundled binaries for notarization..."

          # Sign syftbox
          SYFTBOX_BIN="src-tauri/resources/syftbox/syftbox"
          if [[ -f "$SYFTBOX_BIN" ]]; then
            echo "Signing syftbox client..."
            codesign --force --options runtime --timestamp --sign "$APPLE_SIGNING_IDENTITY" "$SYFTBOX_BIN"
          fi

          # Sign all uv binaries
          if [[ -d "src-tauri/resources/bundled/uv" ]]; then
            find src-tauri/resources/bundled/uv -type f -perm +111 | while read -r bin; do
              echo "Signing uv binary: $bin"
              codesign --force --options runtime --timestamp --sign "$APPLE_SIGNING_IDENTITY" "$bin"
            done
          fi

          # Sign all java binaries
          if [[ -d "src-tauri/resources/bundled/java" ]]; then
            find src-tauri/resources/bundled/java -type f -perm +111 | while read -r bin; do
              echo "Signing java binary: $bin"
              codesign --force --options runtime --timestamp --sign "$APPLE_SIGNING_IDENTITY" "$bin" || true
            done
            find src-tauri/resources/bundled/java -name "*.dylib" -type f | while read -r lib; do
              echo "Signing java dylib: $lib"
              codesign --force --options runtime --timestamp --sign "$APPLE_SIGNING_IDENTITY" "$lib" || true
            done
          fi

          # Sign all nextflow binaries
          if [[ -d "src-tauri/resources/bundled/nextflow" ]]; then
            find src-tauri/resources/bundled/nextflow -type f -perm +111 | while read -r bin; do
              echo "Signing nextflow binary: $bin"
              codesign --force --options runtime --timestamp --sign "$APPLE_SIGNING_IDENTITY" "$bin" || true
            done
          fi

          echo "Finished signing bundled binaries"

      - name: Build app
        run: |
          tauri build --target x86_64-apple-darwin

      - name: Verify artifacts
        run: |
          echo "Checking for built artifacts..."
          ls -lh src-tauri/target/x86_64-apple-darwin/release/bundle/dmg/ || echo "No dmg directory"
          ls -lh src-tauri/target/x86_64-apple-darwin/release/bundle/macos/ || echo "No macos directory"

      - name: Clean up keychains
        if: always()
        run: |
          keychains=$(security list-keychains | tr -d '" "')
          echo "$keychains" | while IFS= read -r keychain; do
            if [[ "$keychain" != "/Library/Keychains/System.keychain" && "$keychain" != "/Library/Keychains/SystemRootCertificates.keychain" ]]; then
              echo "Deleting keychain: $keychain"
              security delete-keychain "$keychain"
            fi
          done

  linux-x64-build:
    name: Linux x64 build
    runs-on: ubuntu-22.04
    if: github.event_name == 'pull_request' && github.event.pull_request.base.ref == 'main'
    env:
      APPIMAGE_EXTRACT_AND_RUN: 1
      LINUXDEPLOY: /tmp/linuxdeploy-extracted/usr/bin/linuxdeploy
      LINUXDEPLOY_PLUGIN_APPIMAGE: /tmp/plugin-extracted/usr/bin/linuxdeploy-plugin-appimage
      APPIMAGETOOL: /tmp/plugin-extracted/appimagetool-prefix/usr/bin/appimagetool
      TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
      TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            build-essential \
            pkg-config \
            curl \
            xdg-utils \
            wget \
            file \
            libxdo-dev \
            libssl-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libsqlite3-dev \
            libfuse2 \
            patchelf \
            libgtk-3-dev \
            squashfs-tools \
            desktop-file-utils \
            zsync \
            appstream

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install protoc
        uses: arduino/setup-protoc@v2
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Tauri CLI
        run: npm install -g @tauri-apps/cli@latest

      - name: Setup Go (syftbox)
        uses: actions/setup-go@v5
        with:
          go-version-file: biovault/syftbox/go.mod
          cache: true
          cache-dependency-path: biovault/syftbox/go.sum

      - name: Install npm dependencies
        run: npm ci

      - name: Fetch bundled dependencies
        run: |
          chmod +x scripts/fetch-bundled-deps.sh
          ./scripts/fetch-bundled-deps.sh
          chmod -R u+rw src-tauri/resources/bundled/ || true

      - name: Build syftbox client
        run: |
          chmod +x scripts/build-syftbox-prod.sh
          ./scripts/build-syftbox-prod.sh

      - name: Setup AppImage tools
        run: |
          APPIMAGE_ARCH="x86_64"

          # linuxdeploy
          wget -q "https://github.com/tauri-apps/binary-releases/releases/download/linuxdeploy/linuxdeploy-${APPIMAGE_ARCH}.AppImage" -O /tmp/linuxdeploy.AppImage
          chmod +x /tmp/linuxdeploy.AppImage
          cd /tmp && APPIMAGE_EXTRACT_AND_RUN=1 ./linuxdeploy.AppImage --appimage-extract || true
          if [ ! -d /tmp/squashfs-root ]; then
            OFFSET=$(readelf -h /tmp/linuxdeploy.AppImage | grep "Start of section" | awk '{print $NF}')
            unsquashfs -offset $OFFSET -d /tmp/squashfs-root /tmp/linuxdeploy.AppImage || \
            unsquashfs -d /tmp/squashfs-root /tmp/linuxdeploy.AppImage
          fi
          mv /tmp/squashfs-root /tmp/linuxdeploy-extracted
          chmod +x /tmp/linuxdeploy-extracted/AppRun

          # linuxdeploy-plugin-appimage
          wget -q "https://github.com/linuxdeploy/linuxdeploy-plugin-appimage/releases/download/continuous/linuxdeploy-plugin-appimage-${APPIMAGE_ARCH}.AppImage" -O /tmp/plugin.AppImage
          chmod +x /tmp/plugin.AppImage
          cd /tmp && APPIMAGE_EXTRACT_AND_RUN=1 ./plugin.AppImage --appimage-extract || true
          if [ ! -d /tmp/squashfs-root ]; then
            OFFSET=$(readelf -h /tmp/plugin.AppImage | grep "Start of section" | awk '{print $NF}')
            unsquashfs -offset $OFFSET -d /tmp/squashfs-root /tmp/plugin.AppImage || \
            unsquashfs -d /tmp/squashfs-root /tmp/plugin.AppImage
          fi
          mv /tmp/squashfs-root /tmp/plugin-extracted
          chmod +x /tmp/plugin-extracted/AppRun

          echo "AppImage tools extracted successfully"

          {
            echo "LINUXDEPLOY=/tmp/linuxdeploy-extracted/usr/bin/linuxdeploy"
            echo "LINUXDEPLOY_PLUGIN_APPIMAGE=/tmp/plugin-extracted/usr/bin/linuxdeploy-plugin-appimage"
            echo "APPIMAGETOOL=/tmp/plugin-extracted/appimagetool-prefix/usr/bin/appimagetool"
          } >> "$GITHUB_ENV"

      - name: Build app
        run: |
          set -o pipefail
          tauri build --target x86_64-unknown-linux-gnu --verbose 2>&1 | tee tauri-linux.log

      - name: Verify artifacts
        run: |
          echo "Checking for built artifacts..."
          ls -lh src-tauri/target/x86_64-unknown-linux-gnu/release/bundle/deb/ || echo "No deb directory"
          ls -lh src-tauri/target/x86_64-unknown-linux-gnu/release/bundle/rpm/ || echo "No rpm directory"
          ls -lh src-tauri/target/x86_64-unknown-linux-gnu/release/bundle/appimage/ || echo "No appimage directory"

      - name: Dump logs on failure
        if: failure()
        run: |
          echo "Searching for linuxdeploy/appimage logs..."
          find src-tauri/target/x86_64-unknown-linux-gnu/release -maxdepth 5 -type f \( -iname "*linuxdeploy*.log*" -o -iname "*appimage*.log*" \) -print -exec sed -n '1,400p' {} \;
          echo "Dumping tauri-linux.log (if present)..."
          sed -n '1,400p' tauri-linux.log || true

  linux-arm64-build:
    name: Linux arm64 build
    runs-on: ubuntu-24.04-arm
    if: github.event_name == 'pull_request' && github.event.pull_request.base.ref == 'main'
    env:
      APPIMAGE_EXTRACT_AND_RUN: 1
      LINUXDEPLOY: /tmp/linuxdeploy-extracted/usr/bin/linuxdeploy
      LINUXDEPLOY_PLUGIN_APPIMAGE: /tmp/plugin-extracted/usr/bin/linuxdeploy-plugin-appimage
      APPIMAGETOOL: /tmp/plugin-extracted/appimagetool-prefix/usr/bin/appimagetool
      TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
      TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            build-essential \
            pkg-config \
            curl \
            xdg-utils \
            wget \
            file \
            libxdo-dev \
            libssl-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            libsqlite3-dev \
            libfuse2 \
            patchelf \
            libgtk-3-dev \
            squashfs-tools \
            desktop-file-utils \
            zsync \
            appstream

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-unknown-linux-gnu

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install protoc
        uses: arduino/setup-protoc@v2
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Tauri CLI
        run: npm install -g @tauri-apps/cli@latest

      - name: Install npm dependencies
        run: npm ci

      - name: Create placeholder resources (arm64 no-bundle build)
        run: |
          # Create placeholder directories and files for resources that tauri.conf.json expects
          mkdir -p src-tauri/resources/syftbox
          mkdir -p src-tauri/resources/bundled/java
          mkdir -p src-tauri/resources/bundled/nextflow
          mkdir -p src-tauri/resources/bundled/uv

          # Create placeholder files
          touch src-tauri/resources/syftbox/syftbox
          echo "Placeholder - bundled deps not included in arm64 build" > src-tauri/resources/bundled/README.txt
          touch src-tauri/resources/bundled/java/.placeholder
          touch src-tauri/resources/bundled/nextflow/.placeholder
          touch src-tauri/resources/bundled/uv/.placeholder

      - name: Setup AppImage tools
        run: |
          APPIMAGE_ARCH="aarch64"

          # linuxdeploy
          wget -q "https://github.com/tauri-apps/binary-releases/releases/download/linuxdeploy/linuxdeploy-${APPIMAGE_ARCH}.AppImage" -O /tmp/linuxdeploy.AppImage
          chmod +x /tmp/linuxdeploy.AppImage
          cd /tmp && APPIMAGE_EXTRACT_AND_RUN=1 ./linuxdeploy.AppImage --appimage-extract || true
          if [ ! -d /tmp/squashfs-root ]; then
            OFFSET=$(readelf -h /tmp/linuxdeploy.AppImage | grep "Start of section" | awk '{print $NF}')
            unsquashfs -offset $OFFSET -d /tmp/squashfs-root /tmp/linuxdeploy.AppImage || \
            unsquashfs -d /tmp/squashfs-root /tmp/linuxdeploy.AppImage
          fi
          mv /tmp/squashfs-root /tmp/linuxdeploy-extracted
          chmod +x /tmp/linuxdeploy-extracted/AppRun

          # linuxdeploy-plugin-appimage
          wget -q "https://github.com/linuxdeploy/linuxdeploy-plugin-appimage/releases/download/continuous/linuxdeploy-plugin-appimage-${APPIMAGE_ARCH}.AppImage" -O /tmp/plugin.AppImage
          chmod +x /tmp/plugin.AppImage
          cd /tmp && APPIMAGE_EXTRACT_AND_RUN=1 ./plugin.AppImage --appimage-extract || true
          if [ ! -d /tmp/squashfs-root ]; then
            OFFSET=$(readelf -h /tmp/plugin.AppImage | grep "Start of section" | awk '{print $NF}')
            unsquashfs -offset $OFFSET -d /tmp/squashfs-root /tmp/plugin.AppImage || \
            unsquashfs -d /tmp/squashfs-root /tmp/plugin.AppImage
          fi
          mv /tmp/squashfs-root /tmp/plugin-extracted
          chmod +x /tmp/plugin-extracted/AppRun

          echo "AppImage tools extracted successfully"

          {
            echo "LINUXDEPLOY=/tmp/linuxdeploy-extracted/usr/bin/linuxdeploy"
            echo "LINUXDEPLOY_PLUGIN_APPIMAGE=/tmp/plugin-extracted/usr/bin/linuxdeploy-plugin-appimage"
            echo "APPIMAGETOOL=/tmp/plugin-extracted/appimagetool-prefix/usr/bin/appimagetool"
          } >> "$GITHUB_ENV"

      - name: Build app
        run: |
          set -o pipefail
          tauri build --target aarch64-unknown-linux-gnu --verbose 2>&1 | tee tauri-linux.log

      - name: Verify artifacts
        run: |
          echo "Checking for built artifacts..."
          ls -lh src-tauri/target/aarch64-unknown-linux-gnu/release/bundle/deb/ || echo "No deb directory"
          ls -lh src-tauri/target/aarch64-unknown-linux-gnu/release/bundle/rpm/ || echo "No rpm directory"
          ls -lh src-tauri/target/aarch64-unknown-linux-gnu/release/bundle/appimage/ || echo "No appimage directory"

      - name: Dump logs on failure
        if: failure()
        run: |
          echo "Searching for linuxdeploy/appimage logs..."
          find src-tauri/target/aarch64-unknown-linux-gnu/release -maxdepth 5 -type f \( -iname "*linuxdeploy*.log*" -o -iname "*appimage*.log*" \) -print -exec sed -n '1,400p' {} \;
          echo "Dumping tauri-linux.log (if present)..."
          sed -n '1,400p' tauri-linux.log || true
