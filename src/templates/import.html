<!-- Import Modal - Redesigned Unified Flow -->
<div
	id="import-modal"
	class="modal import-modal"
	hidden
	role="dialog"
	aria-modal="true"
	aria-labelledby="import-modal-title"
>
	<div class="modal-backdrop" data-modal-close="import"></div>
	<div class="modal-panel import-modal-panel">
		<!-- Header -->
		<div class="import-modal-header">
			<div class="import-header-left">
				<h2 id="import-modal-title" class="import-modal-title">Import Data</h2>
			</div>
			<button type="button" class="modal-close-btn" data-modal-close="import" aria-label="Close">
				<svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor">
					<path
						d="M3.72 3.72a.75.75 0 0 1 1.06 0L8 6.94l3.22-3.22a.749.749 0 0 1 1.275.326.749.749 0 0 1-.215.734L9.06 8l3.22 3.22a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L8 9.06l-3.22 3.22a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042L6.94 8 3.72 4.78a.75.75 0 0 1 0-1.06Z"
					/>
				</svg>
			</button>
		</div>

		<!-- Unified Body -->
		<div class="import-modal-body">
			<!-- Progress Indicator (sticky top) -->
			<div class="import-progress-bar hidden" id="detection-progress">
				<div class="progress-bar-fill" id="progress-bar-fill"></div>
				<div class="progress-text" id="progress-text">Processing...</div>
			</div>

			<!-- Step 1: Selection & Configuration -->
			<div class="import-step" id="import-selection-view">
				<!-- Folder Selection -->
				<div class="import-section folder-section">
					<div class="folder-dropzone" id="folder-dropzone">
						<div class="dropzone-content">
							<div class="dropzone-icon">
								<svg width="48" height="48" viewBox="0 0 16 16" fill="currentColor">
									<path
										d="M1.75 2.5A1.75 1.75 0 0 0 0 4.25v7.5C0 12.99 1.01 14 2.25 14h11.5c1.24 0 2.25-1.01 2.25-2.25v-6.5A1.75 1.75 0 0 0 14.25 3.5H7.5L6.29 2.29A1.75 1.75 0 0 0 5.06 1.75H1.75Z"
									/>
								</svg>
							</div>
							<div class="dropzone-text">
								<div class="dropzone-title" id="folder-display">
									Drop folder here or click to browse
								</div>
								<div class="dropzone-subtitle">Select a folder containing your data files</div>
							</div>
							<button
								type="button"
								class="dropzone-clear-btn"
								id="dropzone-clear-btn"
								title="Clear selection"
								style="display: none"
							>
								<svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor">
									<path
										d="M3.72 3.72a.75.75 0 0 1 1.06 0L8 6.94l3.22-3.22a.749.749 0 0 1 1.275.326.749.749 0 0 1-.215.734L9.06 8l3.22 3.22a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L8 9.06l-3.22 3.22a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042L6.94 8 3.72 4.78a.75.75 0 0 1 0-1.06Z"
									/>
								</svg>
							</button>
						</div>
					</div>
				</div>

				<!-- File Types Filter -->
				<div
					class="import-section file-types-section"
					id="file-types-section"
					style="display: none"
				>
					<label class="section-label">File Types</label>
					<div class="file-type-chips" id="file-type-list"></div>
				</div>

				<!-- Pattern Detection (Always Visible When Files Load) -->
				<div
					class="import-section pattern-section"
					id="pattern-detection-section"
					style="display: none"
				>
					<div class="pattern-section-header">
						<div class="pattern-header-left">
							<img
								src="assets/icons/wand-sparkles.svg"
								width="20"
								height="20"
								alt=""
								class="pattern-icon"
							/>
							<label class="section-label">Extract Participant IDs</label>
						</div>
						<button
							type="button"
							class="pattern-dismiss-btn"
							id="pattern-dismiss-btn"
							title="Hide suggestions"
						>
							<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
								<path
									d="M3.72 3.72a.75.75 0 0 1 1.06 0L8 6.94l3.22-3.22a.749.749 0 0 1 1.275.326.749.749 0 0 1-.215.734L9.06 8l3.22 3.22a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L8 9.06l-3.22 3.22a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042L6.94 8 3.72 4.78a.75.75 0 0 1 0-1.06Z"
								/>
							</svg>
						</button>
					</div>
					<div class="pattern-suggestions-grid" id="pattern-suggestions"></div>
					<div class="pattern-manual-controls">
						<button
							type="button"
							class="pattern-action-btn"
							id="random-ids-btn"
							title="Assign random IDs to selected files"
						>
							<img src="assets/icons/random.svg" width="16" height="16" alt="" />
							Random IDs
						</button>
						<div class="pattern-custom-group">
							<input
								type="text"
								id="custom-pattern"
								class="pattern-input"
								placeholder="Custom pattern (e.g., {parent})"
							/>
							<button
								type="button"
								class="pattern-info-btn"
								id="pattern-info-btn"
								title="Pattern help"
							>
								<img src="assets/icons/info.svg" width="16" height="16" alt="" />
							</button>
						</div>
					</div>
				</div>

				<!-- Files Table -->
				<div class="import-section files-section" id="files-panel" style="display: none">
					<div class="files-section-header">
						<div class="files-header-left">
							<label class="section-label">Files</label>
							<div class="file-stats">
								<span class="stat-item"> <strong id="file-count">0</strong> files found </span>
								<span class="stat-item"> <strong id="selected-count">0</strong> selected </span>
								<span class="stat-item stat-warning" id="missing-ids-stat" style="display: none">
									<strong id="missing-ids-count">0</strong> need IDs
								</span>
							</div>
						</div>
						<div class="files-header-right">
							<input
								type="checkbox"
								id="select-all-files"
								class="select-all-checkbox"
								title="Select all files"
							/>
							<label for="select-all-files">Select all</label>
							<div
								class="file-validation-actions"
								id="file-validation-actions"
								style="display: none"
							>
								<button
									type="button"
									class="action-btn-secondary"
									id="filter-missing-ids-btn"
									title="Show only files missing IDs"
								>
									Filter
								</button>
								<button
									type="button"
									class="action-btn-primary"
									id="jump-to-missing-btn"
									title="Jump to next file missing ID"
								>
									Jump to missing
								</button>
							</div>
						</div>
					</div>
					<div class="file-table-wrapper">
						<table class="file-table" role="table">
							<thead>
								<tr>
									<th style="width: 40px">
										<span class="sr-only">Select</span>
									</th>
									<th data-sort="path" style="cursor: pointer">
										File
										<span class="sort-indicator"></span>
									</th>
									<th style="width: 200px">Participant ID</th>
									<th style="width: 50px">
										<span class="sr-only">Actions</span>
									</th>
								</tr>
							</thead>
							<tbody id="file-list"></tbody>
						</table>
					</div>
				</div>
			</div>

			<!-- Step 2: Review & Configure (Inline, no separate view) -->
			<div class="import-step" id="import-step-2" style="display: none">
				<div class="import-section review-section" id="import-modal-review">
					<div class="review-section-header">
						<div class="review-header-left">
							<label class="section-label">Review & Configure Files</label>
							<div class="file-stats">
								<span class="stat-item"> <strong id="review-file-count">0</strong> files </span>
								<span class="stat-item">
									<strong id="review-selected-count">0</strong> selected
								</span>
								<span class="stat-item stat-warning" id="incomplete-stat" style="display: none">
									<strong id="incomplete-review-count">0</strong> need config
								</span>
							</div>
						</div>
						<div class="review-header-right">
							<input
								type="checkbox"
								id="select-all-review"
								class="select-all-checkbox"
								title="Select all files"
							/>
							<label for="select-all-review">Select all</label>
							<button
								type="button"
								class="action-btn-secondary"
								id="detect-types-btn"
								title="Auto-detect file types"
							>
								<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
									<path
										d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zM5.354 4.646L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 1 1 .708-.708z"
									/>
								</svg>
								Auto-detect
							</button>
							<div
								class="file-validation-actions"
								id="review-validation-actions"
								style="display: none"
							>
								<button
									type="button"
									class="action-btn-secondary"
									id="filter-incomplete-review-btn"
								>
									Filter
								</button>
								<button type="button" class="action-btn-primary" id="jump-to-incomplete-review-btn">
									Jump to incomplete
								</button>
							</div>
						</div>
					</div>
					<div class="file-table-wrapper">
						<table class="file-table review-table" role="table">
							<thead>
								<tr>
									<th style="width: 40px">
										<span class="sr-only">Select</span>
									</th>
									<th data-sort="path" style="cursor: pointer; width: 200px; max-width: 200px">
										File
										<span class="sort-indicator"></span>
									</th>
									<th style="width: 140px">
										<div class="review-column-header">
											<span>Data Type</span>
											<select
												id="set-all-datatype"
												class="bulk-select"
												title="Set for all selected"
											>
												<option value="">Set all...</option>
												<option value="Unknown">Unknown</option>
												<option value="Genotype">Genotype</option>
												<option value="Phenotype">Phenotype</option>
											</select>
										</div>
									</th>
									<th style="width: 220px">
										<div class="review-column-header">
											<span>Source</span>
											<select id="set-all-source" class="bulk-select" title="Set for all selected">
												<option value="">Set all...</option>
												<option value="23andMe">23andMe</option>
												<option value="AncestryDNA">AncestryDNA</option>
												<option value="Genes for Good">Genes for Good</option>
												<option value="Dynamic DNA">Dynamic DNA</option>
												<option value="Living DNA">Living DNA</option>
												<option value="MyHeritage">MyHeritage</option>
												<option value="FamilyTreeDNA">FamilyTreeDNA</option>
												<option value="deCODEme">deCODEme</option>
												<option value="Dante Labs">Dante Labs</option>
												<option value="Unknown">Unknown</option>
											</select>
										</div>
									</th>
									<th style="width: 150px">
										<div class="review-column-header">
											<span>GRCh</span>
											<select
												id="set-all-grch-version"
												class="bulk-select"
												title="Set for all selected"
											>
												<option value="">Set all...</option>
												<option value="Unknown">Unknown</option>
												<option value="GRCh36">36</option>
												<option value="GRCh37">37</option>
												<option value="GRCh38">38</option>
											</select>
										</div>
									</th>
									<th style="width: 50px">
										<span class="sr-only">Actions</span>
									</th>
								</tr>
							</thead>
							<tbody id="review-files-table"></tbody>
						</table>
					</div>
				</div>
			</div>
		</div>

		<!-- Footer -->
		<div class="import-modal-footer" id="import-footer">
			<div class="footer-left">
				<button
					type="button"
					class="footer-btn-secondary"
					id="import-back-btn"
					style="display: none"
				>
					‚Üê Back to Selection
				</button>
				<div class="import-status" id="import-status" role="status" aria-live="polite"></div>
			</div>
			<div class="footer-right">
				<button type="button" class="footer-btn-secondary" data-modal-close="import">Cancel</button>
				<button type="button" class="footer-btn-primary" id="import-continue-btn" disabled>
					Review & Configure ‚Üí
				</button>
				<button
					type="button"
					class="footer-btn-primary"
					id="review-import-btn"
					style="display: none"
				>
					Import Files ‚Üí
				</button>
			</div>
		</div>
	</div>
</div>

<!-- Pattern Info Modal -->
<div
	id="pattern-info-modal"
	class="modal"
	hidden
	role="dialog"
	aria-modal="true"
	aria-labelledby="pattern-info-title"
>
	<div class="modal-backdrop" data-modal-close="pattern-info"></div>
	<div class="modal-panel pattern-info-panel">
		<div class="pattern-info-header">
			<h2 id="pattern-info-title">Pattern Help</h2>
			<button
				type="button"
				class="modal-close-btn"
				data-modal-close="pattern-info"
				aria-label="Close"
			>
				<svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor">
					<path
						d="M3.72 3.72a.75.75 0 0 1 1.06 0L8 6.94l3.22-3.22a.749.749 0 0 1 1.275.326.749.749 0 0 1-.215.734L9.06 8l3.22 3.22a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L8 9.06l-3.22 3.22a.751.751 0 0 1-1.042-.018.751.751 0 0 1-.018-1.042L6.94 8 3.72 4.78a.75.75 0 0 1 0-1.06Z"
					/>
				</svg>
			</button>
		</div>
		<div class="pattern-info-body">
			<p>Use these patterns to extract participant IDs from file paths:</p>
			<div class="pattern-examples">
				<div class="pattern-example">
					<code>{parent}</code>
					<p>Uses the parent folder name as the ID</p>
					<small>Example: <code>participants/12345/file.txt</code> ‚Üí ID: <code>12345</code></small>
				</div>
				<div class="pattern-example">
					<code>{filename}</code>
					<p>Uses the filename without extension as the ID</p>
					<small
						>Example: <code>participant_ABC.txt</code> ‚Üí ID: <code>participant_ABC</code></small
					>
				</div>
				<div class="pattern-example">
					<code>{basename}</code>
					<p>Uses the full filename (with extension) as the ID</p>
					<small>Example: <code>data.txt</code> ‚Üí ID: <code>data.txt</code></small>
				</div>
			</div>
			<p class="pattern-tip">
				üí° <strong>Tip:</strong> Click the suggested patterns above for the easiest setup!
			</p>
		</div>
		<div class="pattern-info-footer">
			<button type="button" class="btn-primary" data-modal-close="pattern-info">Got it</button>
		</div>
	</div>
</div>
